<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Graduation Pickup Checker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Font -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet" />

  <!-- SheetJS -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    :root{
      --bg-main:#05060c;
      --bg-card:#11121a;
      --bg-card-soft:#161722;

      /* Accent (off-white like your logo) */
      --accent:#FEF7E4;
      --accent-dim:#CFC4AA;

      --text-main:#f6f6f6;
      --text-muted:#b2b2b8;

      --input-bg:#15151c;
      --border-soft:#2b2b35;
      --shadow-soft:0 18px 40px rgba(0,0,0,0.9);

      --radius-lg:22px;
      --radius-md:16px;
      --radius-pill:999px;

      --transition-soft:0.35s ease;
      --transition-spring:0.45s cubic-bezier(0.22, 1, 0.36, 1);
    }

    *{box-sizing:border-box;margin:0;padding:0}

    body{
      font-family:"Poppins",system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      min-height:100vh;
      display:flex;
      justify-content:center;
      padding:18px 12px 60px;
      overflow-x:hidden;
      position:relative;
      background:radial-gradient(circle at top,#191b27 0,#05060c 55%,#000 100%);
      color:var(--text-main);
    }

    body::before{
      content:"";
      position:fixed;
      inset:-40px;
      pointer-events:none;
      background:
        radial-gradient(circle at top center,rgba(255,255,255,0.03),transparent 55%),
        radial-gradient(circle at bottom,rgba(0,0,0,0.8),transparent 55%);
      z-index:0;
    }

    a{color:inherit;text-decoration:none}
    button{font-family:inherit}

    .orb{
      position:fixed;
      width:220px;height:220px;border-radius:50%;
      background:radial-gradient(circle at 30% 30%,rgba(254,247,228,0.18),rgba(10,14,18,0.2));
      filter:blur(4px);
      top:8%;
      left:50%;
      transform:translateX(-50%);
      opacity:0.12;
      pointer-events:none;
      animation:orbFloat 12s ease-in-out infinite;
      z-index:0;
    }
    .orb.orb-boost{animation:orbBoost 0.9s ease-out}

    @keyframes orbFloat{
      0%{transform:translate(-50%,-4px) scale(1)}
      50%{transform:translate(-51%,6px) scale(1.03)}
      100%{transform:translate(-50%,-4px) scale(1)}
    }
    @keyframes orbBoost{
      0%{transform:translate(-50%,0) scale(1);opacity:0.18}
      40%{transform:translate(-50%,-8px) scale(1.12);opacity:0.22}
      100%{transform:translate(-50%,-4px) scale(1);opacity:0.12}
    }

    .app-shell{
      position:relative;
      z-index:1;
      width:100%;
      max-width:480px;
      margin:0 auto;
    }

    /* Header */
    .header{
      text-align:center;
      margin-top:20px;
      margin-bottom:16px;
      transition:transform 0.35s ease-out, opacity 0.35s ease-out;
    }

    /* Logo: NO SQUARE, show PNG directly */
    .logo-wrapper{
      display:flex;
      align-items:center;
      justify-content:center;
      margin-bottom:10px;
    }
    .logo-wrapper img{
      width:88px;
      height:auto;
      display:block;
      filter:drop-shadow(0 10px 18px rgba(0,0,0,0.75));
    }

    .header-title{
      font-size:1.35rem;
      letter-spacing:0.12em;
      text-transform:uppercase;
      font-weight:600;
      color:var(--accent);
    }

    /* Main card */
    .card{
      background:radial-gradient(circle at top left,#22232f 0,#10111a 45%,#080912 100%);
      border-radius:var(--radius-lg);
      box-shadow:var(--shadow-soft);
      padding:16px 16px 18px;
      border:1px solid rgba(255,255,255,0.03);
      position:relative;
      overflow:hidden;
      transition:transform 0.35s ease-out;
    }
    .card-main{margin-bottom:14px}

    .card::before{
      content:"";
      position:absolute; inset:0;
      border-radius:inherit;
      background:radial-gradient(circle at top,rgba(254,247,228,0.10),transparent 60%);
      opacity:0;
      pointer-events:none;
      transition:opacity 0.6s ease-out;
    }
    .card-glow::before{
      opacity:1;
      animation:cardGlowPulse 1.2s ease-out forwards;
    }
    @keyframes cardGlowPulse{
      0%{opacity:0}
      30%{opacity:1}
      100%{opacity:0}
    }

    .section-label{
      font-size:0.78rem;
      text-transform:uppercase;
      letter-spacing:0.16em;
      color:var(--text-muted);
      margin-bottom:10px;
    }

    .input-row{display:flex;gap:8px;margin-bottom:8px}
    .input-row input{
      flex:1;
      padding:10px 14px;
      border-radius:var(--radius-pill);
      border:1px solid var(--border-soft);
      background:var(--input-bg);
      color:var(--text-main);
      font-size:0.96rem;
      outline:none;
      transition:border-color var(--transition-soft), box-shadow var(--transition-soft), background var(--transition-soft);
    }
    .input-row input::placeholder{color:#6b6b73}
    .input-row input:focus{
      border-color:rgba(254,247,228,0.7);
      box-shadow:0 0 0 1px rgba(254,247,228,0.35), 0 0 18px rgba(254,247,228,0.12);
      background:#181822;
    }

    .primary-btn{
      padding:0 16px;
      border-radius:var(--radius-pill);
      border:1px solid rgba(254,247,228,0.35);
      background:#0b0b10;
      color:var(--accent);
      font-weight:600;
      font-size:0.9rem;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      white-space:nowrap;
      box-shadow:0 8px 18px rgba(0,0,0,0.65);
      transition:transform 0.18s ease-out, box-shadow 0.18s ease-out, filter 0.18s ease-out;
    }
    .primary-btn:active{
      transform:translateY(1px) scale(0.98);
      box-shadow:0 4px 12px rgba(0,0,0,0.8);
      filter:brightness(0.96);
    }

    .hint-text{font-size:0.74rem;color:var(--text-muted);margin-bottom:4px}
    .error-text{font-size:0.78rem;color:#ff9b6a;min-height:16px;margin-top:2px}

    /* Results */
    .results-wrapper{margin-top:10px;display:none;transition:transform 0.35s ease-out, opacity 0.35s ease-out}
    .results-title{font-size:0.9rem;margin-bottom:8px;color:var(--text-muted)}

    .result-card{
      background:radial-gradient(circle at top left,#22232f 0,#11111a 40%,#080912 100%);
      border-radius:var(--radius-lg);
      padding:14px 14px 16px;
      border:1px solid rgba(255,255,255,0.04);
      margin-bottom:10px;
      position:relative;
      overflow:hidden;
    }

    .result-card-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:8px;
    }

    .result-title{font-size:0.98rem;font-weight:600}
    .result-sub{font-size:0.78rem;color:var(--text-muted)}

    .info-grid{
      display:grid;
      grid-template-columns:repeat(2,minmax(0,1fr));
      gap:8px;
      margin-top:8px;
    }

    .info-box{
      border-radius:var(--radius-md);
      background:linear-gradient(145deg,#171822,#0f1018);
      box-shadow:0 12px 26px rgba(0,0,0,0.9), inset 0 0 0 1px rgba(255,255,255,0.03);
      padding:8px 10px;
    }

    .info-label{
      font-size:0.72rem;
      text-transform:uppercase;
      letter-spacing:0.12em;
      color:var(--text-muted);
      margin-bottom:3px;
    }

    .info-value{
      font-size:0.9rem;
      font-weight:600;
      color:var(--accent);
      display:flex;
      align-items:center;
      gap:8px;
      min-height:28px;
      word-break:break-word;
    }

    .info-value-badge{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width:28px;height:28px;border-radius:50%;
      background:rgba(254,247,228,0.14);
      border:1px solid rgba(254,247,228,0.45);
      box-shadow:0 8px 16px rgba(0,0,0,0.65);
      color:var(--accent);
      font-weight:700;
      font-size:0.86rem;
      transform:scale(0);
      opacity:0;
      flex:0 0 auto;
    }
    .info-value-badge.pop-in{animation:badgePop 0.5s var(--transition-spring) forwards}
    @keyframes badgePop{
      0%{transform:scale(0.2) translateY(8px);opacity:0}
      60%{transform:scale(1.1) translateY(-2px);opacity:1}
      100%{transform:scale(1) translateY(0);opacity:1}
    }

    .warning-bar{
      display:flex;
      align-items:flex-start;
      gap:6px;
      margin-top:8px;
      padding:6px 8px;
      border-radius:var(--radius-md);
      background:linear-gradient(120deg,rgba(254,247,228,0.08),rgba(0,0,0,0.0));
      border:1px solid rgba(254,247,228,0.22);
      font-size:0.78rem;
      color:var(--accent);
    }
    .warning-icon{font-size:0.9rem}

    .stadium-preview{
      margin-top:8px;
      border-radius:14px;
      overflow:hidden;
      background:#05060c;
      border:1px solid rgba(255,255,255,0.06);
      cursor:pointer;
      box-shadow:0 10px 20px rgba(0,0,0,0.7);
      text-align:center;
      padding:6px 0 2px;
    }
    .stadium-preview img{
      width:55%;
      max-width:190px;
      display:block;
      margin:0 auto 4px;
      border-radius:12px;
      transform-origin:center center;
      transition:transform 0.25s ease-out;
    }
    .stadium-preview-caption{
      padding:0 10px 7px;
      font-size:0.78rem;
      color:var(--text-muted);
      text-align:center;
    }

    .location-btn{
      width:100%;
      margin-top:8px;
      padding:9px 12px;
      border-radius:var(--radius-pill);
      border:1px solid rgba(254,247,228,0.22);
      background:#0b0b10;
      color:var(--accent);
      font-size:0.84rem;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      cursor:pointer;
      box-shadow:0 10px 22px rgba(0,0,0,0.7);
    }
    .location-btn:active{
      transform:translateY(1px) scale(0.985);
      box-shadow:0 5px 12px rgba(0,0,0,0.8);
    }

    .no-items{font-size:0.84rem;color:var(--text-muted);padding:10px 10px 6px}

    /* Modal */
    .modal-backdrop{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.68);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:3000;
    }
    .modal-backdrop.active{display:flex}

    .modal-dialog{
      width:100%;
      max-width:420px;
      margin:0 18px;
      background:radial-gradient(circle at top,#262633 0,#14141b 45%,#09090d 100%);
      border-radius:22px;
      padding:16px 16px 14px;
      box-shadow:0 20px 45px rgba(0,0,0,0.9);
      border:1px solid rgba(255,255,255,0.04);
      transform:translateY(30px);
      opacity:0;
      transition:transform var(--transition-spring), opacity var(--transition-soft);
    }
    .modal-backdrop.active .modal-dialog{
      transform:translateY(0);
      opacity:1;
    }

    .modal-icon{
      width:34px;height:34px;border-radius:50%;
      background:rgba(254,247,228,0.16);
      border:1px solid rgba(254,247,228,0.35);
      display:flex;
      align-items:center;
      justify-content:center;
      margin-bottom:8px;
      color:var(--accent);
      box-shadow:0 10px 20px rgba(0,0,0,0.8);
    }
    .modal-title{font-size:1rem;font-weight:600;margin-bottom:2px}
    .modal-subtitle{font-size:0.82rem;color:var(--text-muted);margin-bottom:8px}

    .modal-steps{
      margin-bottom:8px;
      max-height:48vh;
      overflow-y:auto;
      padding-right:2px;
    }
    .modal-step{margin-bottom:6px}
    .modal-step-title{font-size:0.82rem;font-weight:600;color:var(--accent);margin-bottom:1px}
    .modal-step-text{font-size:0.78rem;color:var(--text-muted);line-height:1.45}

    .modal-confirm-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-top:6px;
    }
    .modal-checkbox-row{
      display:flex;
      align-items:center;
      gap:6px;
      font-size:0.78rem;
      color:var(--text-muted);
      flex:1;
    }
    .modal-checkbox-row input[type="checkbox"]{
      width:16px;height:16px;
      accent-color:var(--accent);
    }
    .modal-confirm-btn{
      border-radius:var(--radius-pill);
      border:1px solid rgba(254,247,228,0.35);
      padding:7px 12px;
      font-size:0.82rem;
      font-weight:600;
      background:#0b0b10;
      color:var(--accent);
      cursor:pointer;
      white-space:nowrap;
      opacity:0.4;
      pointer-events:none;
      transition:opacity 0.2s ease-out, transform 0.14s ease-out, box-shadow 0.18s ease-out;
      box-shadow:0 8px 20px rgba(0,0,0,0.85);
    }
    .modal-confirm-btn.enabled{opacity:1;pointer-events:auto}
    .modal-confirm-btn:active{
      transform:translateY(1px) scale(0.98);
      box-shadow:0 5px 12px rgba(0,0,0,0.9);
    }

    /* Stadium bottom-sheet */
    .stadium-popup{
      position:fixed;
      bottom:-70%;
      left:0;
      width:100%;
      height:65%;
      background:#0c0d13;
      border-top-left-radius:26px;
      border-top-right-radius:26px;
      box-shadow:0 -12px 40px rgba(0,0,0,0.7);
      transition:transform 0.35s cubic-bezier(0.22,1,0.36,1);
      transform:translateY(100%);
      z-index:2500;
      display:flex;
      flex-direction:column;
      align-items:center;
      padding-top:12px;
      touch-action:none;
    }
    .stadium-popup.active{transform:translateY(0)}
    .stadium-grabber{width:55px;height:6px;background:#444;border-radius:6px;margin-bottom:10px}
    .stadium-popup img{
      width:90%;
      border-radius:16px;
      transition:transform 0.35s cubic-bezier(0.22,1,0.36,1);
      user-select:none;
      pointer-events:none;
      transform:scale(0.85);
    }
    .stadium-popup.active img{transform:scale(1.05)}

    @media (max-width:360px){
      .header-title{font-size:1.25rem}
      .card,.result-card{padding:12px 12px 14px}
      .logo-wrapper img{width:78px}
    }
  </style>
</head>

<body>
  <div class="orb" id="orb"></div>

  <div class="app-shell">
    <header class="header" id="header">
      <div class="logo-wrapper">
        <!-- IMPORTANT: case-sensitive file name -->
        <img src="logo.PNG" alt="Graduation Logo" />
      </div>
      <div class="header-title">GRADUATION TEAM</div>
    </header>

    <main class="card card-main" id="mainCard">
      <div class="section-label">Seat number lookup</div>

      <form id="lookupForm" autocomplete="off">
        <div class="input-row">
          <input
            id="seatInput"
            type="tel"
            inputmode="numeric"
            maxlength="12"
            placeholder="e.g. 20201226"
          />
          <button type="submit" class="primary-btn">
            <span>Check</span>
          </button>
        </div>

        <div class="hint-text">
          Enter your seat number to display the last two columns from the Excel file.
        </div>
        <div id="errorText" class="error-text"></div>
      </form>
    </main>

    <section class="results-wrapper" id="resultsSection">
      <div class="results-title">Your details</div>

      <div class="result-card" id="resultCard" style="display:none;">
        <div class="result-card-header">
          <div>
            <div class="result-title">Pickup Details</div>
            <div class="result-sub" id="seatLabel">Seat ‚Äì</div>
          </div>
        </div>

        <div class="info-grid">
          <div class="info-box">
            <div class="info-label" id="colALabel">Column A</div>
            <div class="info-value">
              <span class="info-value-badge" id="colABadge">A</span>
              <span id="colAValueText"></span>
            </div>
          </div>

          <div class="info-box">
            <div class="info-label" id="colBLabel">Column B</div>
            <div class="info-value" id="colBValueText">‚Äî</div>
          </div>
        </div>

        <div class="warning-bar">
          <span class="warning-icon">‚ö†Ô∏è</span>
          <span>
            Important: Please come only during your assigned time.<br />
            ‚Ä¢ Take a screenshot of your result and bring your ID.
          </span>
        </div>

        <div class="stadium-preview" id="stadiumPreview">
          <img src="stadium_layout.jpg" alt="Stadium layout" />
          <div class="stadium-preview-caption">Tap to view the layout</div>
        </div>

        <!-- Optional location button (keep or change) -->
        <a
          href="https://maps.app.goo.gl/Sg9exBwLkvCzmJAg6?g_st=ipc"
          target="_blank"
          class="location-btn"
        >
          <span>üìç</span>
          <span>Open Location</span>
        </a>
      </div>

      <div class="result-card" id="noItemsCard" style="display:none;">
        <div class="no-items" id="noItemsText">
          This seat number was not found in the file.
        </div>
      </div>
    </section>
  </div>

  <!-- Modal -->
  <div class="modal-backdrop" id="rulesModal">
    <div class="modal-dialog">
      <div class="modal-icon">!</div>
      <div class="modal-title">Before you come</div>
      <div class="modal-subtitle">Please follow these rules.</div>

      <div class="modal-steps">
        <div class="modal-step">
          <div class="modal-step-title">1</div>
          <div class="modal-step-text">
            Bringing your student ID card is mandatory.
          </div>
        </div>

        <div class="modal-step">
          <div class="modal-step-title">2</div>
          <div class="modal-step-text">
            If you cannot come in person, you may send someone on your behalf.
            They must have a clear photo of your ID and your seat number.
          </div>
        </div>

        <div class="modal-step">
          <div class="modal-step-title">3</div>
          <div class="modal-step-text">
            Come only during your assigned time slot.
          </div>
        </div>
      </div>

      <div class="modal-confirm-row">
        <label class="modal-checkbox-row">
          <input type="checkbox" id="rulesCheckbox" />
          <span>I have read and understood these rules.</span>
        </label>
        <button class="modal-confirm-btn" id="rulesConfirmBtn">Continue</button>
      </div>
    </div>
  </div>

  <!-- Bottom-sheet stadium -->
  <div id="stadium-popup" class="stadium-popup">
    <div class="stadium-grabber"></div>
    <img id="stadium-img" src="stadium_layout.jpg" alt="Stadium Layout" />
  </div>

  <script>
    // =========================
    // CONFIG - match your repo files exactly
    // =========================
    const EXCEL_FILE = "Order_Arrangement_UPDATED.xlsx";

    // Possible ID column names (we detect automatically)
    const ID_COL_CANDIDATES = [
      "ID number",
      "Seat number",
      "Seat Number",
      "Student ID",
      "Student ID ( 8 digits e.g.20200456)",
      "Student ID (8 digits e.g.20200456)",
      "Student ID ( 8 digits e.g. 20200456)",
      "ÿ±ŸÇŸÖ ÿßŸÑÿ¨ŸÑŸàÿ≥",
      "ÿ±ŸÇŸÖ ÿ¨ŸÑŸàÿ≥"
    ];

    const dataMap = new Map(); // key => { colAValue, colBValue }
    let dataReady = false;
    let lastColA = "";
    let lastColB = "";

    function normalizeKey(value) {
      if (value === undefined || value === null) return "";
      return String(value).replace(/\D/g, "");
    }

    function getTrimmed(row, targetName) {
      const target = String(targetName || "").trim().toLowerCase();
      for (const key of Object.keys(row)) {
        if (String(key).trim().toLowerCase() === target) return row[key];
      }
      return "";
    }

    function findHeader(headers, candidates) {
      const norm = (s) => String(s || "").trim().toLowerCase();
      const hs = headers.map(h => ({ raw: h, n: norm(h) }));
      for (const c of candidates) {
        const cc = norm(c);
        const hit = hs.find(x => x.n === cc);
        if (hit) return hit.raw;
      }
      return "";
    }

    async function loadWorkbookWithHeaders(url) {
      const res = await fetch(url, { cache: "no-store" });
      if (!res.ok) throw new Error("Failed to load " + url + " (HTTP " + res.status + ")");

      const arrayBuffer = await res.arrayBuffer();
      const workbook = XLSX.read(arrayBuffer, { type: "array" });

      const firstSheetName = workbook.SheetNames[0];
      const sheet = workbook.Sheets[firstSheetName];

      // Array-of-Arrays preserves column order
      const aoa = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: "" });
      if (!aoa || aoa.length === 0) return { headers: [], rows: [] };

      const headers = aoa[0].map(h => String(h).trim());
      const rows = aoa.slice(1).map((arr) => {
        const obj = {};
        headers.forEach((h, i) => { obj[h] = (arr && arr[i] !== undefined) ? arr[i] : ""; });
        return obj;
      });

      return { headers, rows };
    }

    async function loadData() {
      try {
        const { headers, rows } = await loadWorkbookWithHeaders(EXCEL_FILE);
        if (!headers.length) throw new Error("Excel sheet is empty.");

        // Last two columns
        lastColA = headers[headers.length - 2] || "";
        lastColB = headers[headers.length - 1] || "";

        // Find ID column
        const idCol = findHeader(headers, ID_COL_CANDIDATES) || headers[0];

        rows.forEach((row) => {
          const seat = normalizeKey(getTrimmed(row, idCol));
          if (!seat) return;

          const colAValue = getTrimmed(row, lastColA);
          const colBValue = getTrimmed(row, lastColB);
          dataMap.set(seat, { colAValue, colBValue });
        });

        dataReady = true;
      } catch (err) {
        console.error("Error loading data:", err);
        dataReady = false;
      }
    }

    window.addEventListener("load", loadData);

    // DOM refs
    const lookupForm = document.getElementById("lookupForm");
    const seatInput = document.getElementById("seatInput");
    const errorText = document.getElementById("errorText");

    const resultsSection = document.getElementById("resultsSection");
    const resultCard = document.getElementById("resultCard");
    const noItemsCard = document.getElementById("noItemsCard");
    const noItemsText = document.getElementById("noItemsText");

    const seatLabelEl = document.getElementById("seatLabel");
    const colALabelEl = document.getElementById("colALabel");
    const colBLabelEl = document.getElementById("colBLabel");
    const colABadge = document.getElementById("colABadge");
    const colAValueText = document.getElementById("colAValueText");
    const colBValueText = document.getElementById("colBValueText");

    const mainCard = document.getElementById("mainCard");
    const header = document.getElementById("header");
    const orb = document.getElementById("orb");

    const rulesModal = document.getElementById("rulesModal");
    const rulesCheckbox = document.getElementById("rulesCheckbox");
    const rulesConfirmBtn = document.getElementById("rulesConfirmBtn");

    const stadiumPopup = document.getElementById("stadium-popup");
    const stadiumPreview = document.getElementById("stadiumPreview");
    const stadiumPreviewImg = stadiumPreview ? stadiumPreview.querySelector("img") : null;

    let pendingSeat = null;

    // Digits only
    seatInput.addEventListener("input", () => {
      seatInput.value = seatInput.value.replace(/[^0-9]/g, "").slice(0, 12);
    });

    // Modal
    function openRulesModal() {
      rulesCheckbox.checked = false;
      rulesConfirmBtn.classList.remove("enabled");
      rulesModal.classList.add("active");
    }
    function closeRulesModal() { rulesModal.classList.remove("active"); }

    rulesCheckbox.addEventListener("change", () => {
      if (rulesCheckbox.checked) rulesConfirmBtn.classList.add("enabled");
      else rulesConfirmBtn.classList.remove("enabled");
    });

    rulesConfirmBtn.addEventListener("click", () => {
      if (!rulesCheckbox.checked || !pendingSeat) return;
      closeRulesModal();
      applyResults(pendingSeat);
      openStadiumPopup();
      pendingSeat = null;
    });

    // Stadium drag
    let startY = 0, currentY = 0, dragging = false;

    function onDragStart(clientY) { dragging = true; startY = clientY; currentY = 0; }
    function onDragMove(clientY) {
      if (!dragging) return;
      currentY = clientY - startY;
      if (currentY > 0) stadiumPopup.style.transform = "translateY(" + currentY + "px)";
    }
    function onDragEnd() {
      if (!dragging) return;
      dragging = false;

      if (currentY > 140) {
        stadiumPopup.classList.remove("active");
        stadiumPopup.style.transform = "translateY(100%)";
      } else {
        stadiumPopup.classList.add("active");
        stadiumPopup.style.transform = "translateY(0)";
      }
      currentY = 0;
    }

    stadiumPopup.addEventListener("touchstart", (e) => onDragStart(e.touches[0].clientY));
    stadiumPopup.addEventListener("touchmove", (e) => onDragMove(e.touches[0].clientY));
    stadiumPopup.addEventListener("touchend", onDragEnd);

    stadiumPopup.addEventListener("mousedown", (e) => onDragStart(e.clientY));
    window.addEventListener("mousemove", (e) => { if (dragging) onDragMove(e.clientY); });
    window.addEventListener("mouseup", () => { if (dragging) onDragEnd(); });

    function openStadiumPopup() {
      stadiumPopup.classList.add("active");
      stadiumPopup.style.transform = "translateY(0)";
    }

    if (stadiumPreview) stadiumPreview.addEventListener("click", openStadiumPopup);

    // Scroll effects
    window.addEventListener("scroll", () => {
      const y = window.scrollY;
      const max = 180;
      const t = Math.min(y / max, 1);

      mainCard.style.transform = `translateY(${-4 * t}px) scale(${1 - 0.04 * t})`;
      header.style.transform = `translateY(${-6 * t}px)`;
      header.style.opacity = (1 - 0.3 * t).toString();

      resultsSection.style.transform = `translateY(${12 * (1 - t)}px)`;
      resultsSection.style.opacity = (0.1 + 0.9 * t).toString();

      if (stadiumPreviewImg) stadiumPreviewImg.style.transform = `scale(${1 + 0.06 * t})`;
    });

    function boostOrb() {
      orb.classList.remove("orb-boost");
      void orb.offsetWidth;
      orb.classList.add("orb-boost");
    }

    function animateMainCard() {
      mainCard.classList.remove("card-glow");
      void mainCard.offsetWidth;
      mainCard.classList.add("card-glow");
    }

    function showResultsWrapper() {
      resultsSection.style.display = "block";
      resultsSection.scrollIntoView({ behavior: "smooth", block: "start" });
    }

    function applyResults(seat) {
      resultCard.style.display = "none";
      noItemsCard.style.display = "none";

      const payload = dataMap.get(seat);
      if (!payload) {
        noItemsText.textContent = "This seat number was not found in the file.";
        noItemsCard.style.display = "block";
        animateMainCard();
        boostOrb();
        showResultsWrapper();
        return;
      }

      // labels = last two columns
      colALabelEl.textContent = lastColA || "Column A";
      colBLabelEl.textContent = lastColB || "Column B";

      const a = (payload.colAValue ?? "").toString().trim();
      const b = (payload.colBValue ?? "").toString().trim();

      colABadge.textContent = a ? a.charAt(0).toUpperCase() : "-";
      colAValueText.textContent = a || "‚Äî";
      colBValueText.textContent = b || "‚Äî";

      colABadge.classList.remove("pop-in");
      void colABadge.offsetWidth;
      colABadge.classList.add("pop-in");

      seatLabelEl.textContent = "Seat " + seat;

      resultCard.style.display = "block";
      animateMainCard();
      boostOrb();
      showResultsWrapper();
    }

    // Submit
    lookupForm.addEventListener("submit", (e) => {
      e.preventDefault();

      const raw = seatInput.value.trim();
      const seat = normalizeKey(raw);

      errorText.textContent = "";

      if (!seat || seat.length < 4) {
        errorText.textContent = "Please enter a valid seat number.";
        return;
      }

      if (!dataReady) {
        errorText.textContent = "Data is still loading. Please try again in a few seconds.";
        return;
      }

      if (!dataMap.has(seat)) {
        applyResults(seat);
        return;
      }

      pendingSeat = seat;
      openRulesModal();
    });
  </script>
</body>
</html>
